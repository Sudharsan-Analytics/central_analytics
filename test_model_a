with base as (
SELECT 
    bp.pre_user_id,
    purchase_time + INTERVAL 330 MINUTE AS payment_date,
    purchase_price,
    CASE 
        WHEN purchase_price = 399 THEN 'LIY_IND'
        WHEN purchase_price IN (150, 100,50) AND ld.lead_origin_country IN ('SAUDI' ,'UAE') THEN 'LIY_MENA'
     
    END AS business_unit 

FROM scholar_prod_db_v5.bundle_purchase bp 
left join data_warehouse_leap_mart.dwh_leap_lead_dim ld on bp.pre_user_id = ld.pre_user_id

WHERE 
    bp.bundle_id IN (1344, 1503)
    AND bp.purchase_price >= 5 
    AND bp.pre_user_id NOT IN (2240809)
    AND purchase_price IN (399, 150, 100,50)
    --and date(purchase_time + INTERVAL 330 MINUTE) ='2024-07-14'
--     select * from bundle_purchase  bp left join pre_login_leap_user pl on bp.pre_user_id=pl.id where pl.origin_country in('SAUDI' ,'UAE')
-- and purchase_price in ('30','110','50')
-- order by bp.created_at desc

)
   



select pre_user_id,payment_date,purchase_price, case 
          when f.lead_channel is not null and split(f.lead_channel,'~')[2]!='OTHER' then split(f.lead_channel,'~')[2]   
          when sem_ielts_source  is not null then sem_ielts_source 
          else  'OTHER'
      end as purchase_channel,
      business_unit,
      --count(distinct pre_user_id) as channel_enrollment
      case 
          when leads_ad_id is not null and leads_ad_id!='OTHER' then leads_ad_id  
          when sem_ielts_ad_id is not null then sem_ielts_ad_id
      end as purchase_ad_id,
    case 
          when leads_utm_campaign is not null and leads_utm_campaign!='OTHER' then leads_utm_campaign  
          when sem_ielts_campaign is not null then sem_ielts_campaign
        
          end as purchase_campaign,
    case 
          when leads_utm_platform is not null and leads_utm_platform!='OTHER' then leads_utm_platform
          when  sem_ielts_platform is not null then  sem_ielts_platform
        
          end as purchase_platform,
      FROM 
     (

 select e.*,
         case when (lower(sem_ielts) like '%search%' or lower(sem_ielts) like '%google%') then 'GOOGLE_SEARCH'
              when (lower(sem_ielts) like '%facebook%') then 'FACEBOOK'
              when (lower(sem_ielts) like '%yt_%' or lower(sem_ielts) like '%youtube%') then 'YOUTUBE'
              when (lower(sem_ielts) like '%discovery%' or lower(sem_ielts) like '%discovery%') then 'DEMAND_GEN'
              
              else  'OTHER'
             end as sem_ielts_source ,split(lead_channel,'~')[4] as leads_ad_id,split( sem_ielts,'~')[3] as sem_ielts_ad_id,
             split(lead_channel,'~')[6] as leads_utm_campaign,split( sem_ielts,'~')[2] as sem_ielts_campaign,
             split(lead_channel,'~')[3] as leads_utm_platform,split( sem_ielts,'~')[4] as sem_ielts_platform
             
from
(
select a.*,
           max(c.lead_date_time||'~'||coalesce(c.lead_source,'OTHER')||'~'||coalesce(c.lead_channel,'OTHER')
           ||'~'||coalesce(lead_ielts_platform,'OTHER')||'~'||coalesce(lead_ad_id,'OTHER')||'~'||coalesce(lead_utm_source,'OTHER')
           ||'~'||coalesce(lead_utm_campaign,'OTHER')||'~'|| coalesce(b.ad_id,'OTHER')) as lead_channel,
           max((b.updated_at + INTERVAl 330 minute)||'~'||coalesce(b.utm_source,'OTHER')||'~'||coalesce(b.utm_campaign,'OTHER')||'~'||
           coalesce(b.ad_id,'OTHER')||'~'||coalesce(b.platform,'OTHER')) as sem_ielts,
from base a 
left join data_warehouse_leap_mart.dwh_leap_ielts_lead_fact c ON a.pre_user_id = c.pre_user_id 
                                                                  and (date(a.payment_date) >= date(c.lead_date_time))
                                                                  and date_diff(date(a.payment_date),date(c.lead_date_time),day) between 0 and 60
                                                                  and coalesce(lead_channel,'OTHER') IN ('GOOGLE_SEARCH','DEMAND_GEN','FACEBOOK','YOUTUBE')
                                                                  and lead_day_rank = 1

                                                                  
left join 
(
    select pre_user_id,updated_at,utm_source,utm_campaign,ad_id,platform
    from scholar_prod_db_v5.sem_ielts_lead 

) b ON a.pre_user_id = b.pre_user_id
    and payment_date > (b.updated_at + INTERVAl 330 minute)
    and date_diff(date(payment_date),date(b.updated_at + INTERVAl 330 minute),day) <= 60
    and b.utm_source is not null
    and lower(coalesce(b.utm_campaign,'abc')) not like '%mena%'
    and ( lower(coalesce(b.utm_campaign,'abc')) like '%self%prep%' or lower(coalesce(b.utm_campaign,'abc')) like '%liy%')
    and length(b.utm_campaign) >= 15

where date(c.lead_date) >= '2020-01-01'  
group by 1,2,3,4
)e
) f
